<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†ç³»ç»Ÿ - Convex åŠ¨æ€ç‰ˆ</title>
    <!-- å¼•å…¥ SheetJS ç”¨äºå¯¼å…¥å¯¼å‡º Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ Convex å®¢æˆ·ç«¯ -->
    <script src="https://unpkg.com/convex@1.17.0/dist/convex.browser.js"></script>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œå’ŒåŸæ¥ä¸€æ · */
        * { box-sizing: border-box; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f3f5f9; margin: 0; min-height: 100vh; display: flex; justify-content: center; padding: 20px; }
        .system-container { width: 1400px; max-width: 100%; background: white; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; }
        .toolbar { background: white; padding: 18px 24px; border-bottom: 1px solid #e9ecf2; display: flex; flex-wrap: wrap; align-items: center; gap: 16px; }
        .sheet-tabs { display: flex; flex-wrap: wrap; gap: 6px; }
        .sheet-btn { background: #f0f2f6; border: none; padding: 8px 18px; border-radius: 40px; font-size: 14px; font-weight: 500; color: #1e293b; cursor: pointer; transition: all 0.15s; border: 1px solid transparent; }
        .sheet-btn.active { background: #1e2b3c; color: white; box-shadow: 0 4px 10px rgba(0,30,60,0.15); border-color: #1e2b3c; }
        .sheet-btn:hover:not(.active) { background: #e2e6ed; }
        .spacer { flex: 1; }
        .action-buttons { display: flex; gap: 10px; }
        .action-btn { background: white; border: 1.5px solid #d0d7e5; padding: 8px 18px; border-radius: 40px; font-weight: 600; font-size: 13px; color: #1e2b3c; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: 0.1s; }
        .action-btn.primary { background: #0a7c5f; border-color: #0a7c5f; color: white; box-shadow: 0 4px 10px rgba(10,124,95,0.2); }
        .action-btn.primary:hover { background: #0b8e6b; }
        .action-btn:hover { background: #edf2f9; }
        .hidden { display: none !important; }
        .table-wrapper { overflow-x: auto; overflow-y: auto; max-height: 70vh; background: white; padding: 0 8px 8px 8px; scroll-behavior: smooth; }
        table { border-collapse: collapse; width: 100%; min-width: 900px; font-size: 14px; background: white; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        th { background: #f8fafd; color: #1e293b; font-weight: 600; padding: 14px 12px; white-space: nowrap; border-bottom: 2px solid #dde3ed; position: sticky; top: 0; background: #f8fafd; z-index: 10; font-size: 0.85rem; letter-spacing: 0.3px; text-transform: uppercase; text-align: left; }
        td { padding: 12px 12px; border-bottom: 1px solid #eef2f6; color: #1f2a41; vertical-align: middle; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left; }
        tr:hover td { background-color: #fcfcff; }
        .action-cell { display: flex; gap: 8px; justify-content: center; }
        .edit-btn, .delete-btn { border: none; background: none; font-size: 16px; cursor: pointer; padding: 4px 6px; border-radius: 8px; transition: 0.1s; opacity: 0.7; }
        .edit-btn:hover { background: #e6f0ff; opacity: 1; color: #0057b3; }
        .delete-btn:hover { background: #ffeae9; opacity: 1; color: #c6362e; }
        .empty-data { text-align: center; padding: 48px; color: #7eaa2; font-style: italic; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-card { background: white; width: 600px; max-width: 90vw; max-height: 80vh; overflow-y: auto; border-radius: 32px; padding: 28px 32px; box-shadow: 0 30px 50px rgba(0,20,30,0.3); }
        .modal-card h3 { margin: 0 0 20px 0; font-weight: 600; color: #0b1f33; font-size: 1.6rem; }
        .form-grid { display: flex; flex-direction: column; gap: 14px; }
        .form-row { display: flex; flex-direction: column; gap: 4px; }
        .form-row label { font-weight: 600; font-size: 0.85rem; color: #3a4c62; }
        .form-row input { padding: 10px 14px; border: 1.5px solid #dde0e8; border-radius: 16px; font-size: 0.95rem; transition: 0.15s; }
        .form-row input:focus { outline: none; border-color: #0a7c5f; box-shadow: 0 0 0 3px rgba(10,124,95,0.15); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 16px; margin-top: 28px; }
        .modal-btn { padding: 10px 28px; border-radius: 40px; font-weight: 600; border: none; cursor: pointer; background: #e9ecf3; color: #1e2b3c; }
        .modal-btn.primary { background: #0a2e3f; color: white; box-shadow: 0 4px 10px rgba(10,46,63,0.2); }
        .modal-btn.primary:hover { background: #124257; }
        #fileImportInput { display: none; }
    </style>
</head>
<body>
<div class="system-container">
    <div class="toolbar">
        <div class="sheet-tabs" id="sheetTabs"></div>
        <div class="spacer"></div>
        <div class="action-buttons" id="extraActions">
            <button class="action-btn" id="importExcelBtn" title="å¯¼å…¥ Excel (æ›¿æ¢å½“å‰è¡¨æ•°æ®)">ğŸ“¥ å¯¼å…¥</button>
            <button class="action-btn" id="exportExcelBtn" title="å¯¼å‡ºå½“å‰è¡¨ä¸º Excel">ğŸ“¤ å¯¼å‡º</button>
            <button class="action-btn primary" id="addRecordBtn">â• æ–°å¢è®°å½•</button>
        </div>
    </div>

    <div class="table-wrapper" id="tableWrapper">
        <table id="dataTable">
            <thead id="tableHeader"><tr></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- æ–‡ä»¶å¯¼å…¥éšè— input -->
<input type="file" id="fileImportInput" accept=".xlsx, .xls, .csv">

<!-- æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal-card">
        <h3 id="modalTitle">ç¼–è¾‘è®°å½•</h3>
        <div id="modalForm" class="form-grid"></div>
        <div class="modal-actions">
            <button class="modal-btn" id="modalCancel">å–æ¶ˆ</button>
            <button class="modal-btn primary" id="modalSave">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
    (function() {
        // =======================  CONVEX åˆå§‹åŒ–ï¼ˆå·²ä¿®æ­£ï¼‰ =======================
        // ä½¿ç”¨ä½ çš„ Convex éƒ¨ç½² URLï¼ˆä» Dashboard è·å–ï¼‰
        const convexClient = new convex.ConvexClient("https://tough-minnow-254.convex.cloud");

        // è¡¨åä¸æ˜¾ç¤ºåç§°çš„æ˜ å°„ï¼ˆheaders å‡ä¸ºå®Œæ•´æ•°ç»„ï¼‰
        const SHEET_INFO = {
            staff: { name: 'èŒå‘˜', headers: ['èŒå‘˜åç§°', 'è´¦å·', 'å¯†ç '] },
            class: { name: 'è€ƒæœŸç­çº§', headers: ['åºå·', 'è€ƒæœŸ', '1ç­', '2ç­', '3ç­', '4ç­', '5ç­', '6ç­', '7ç­', '8ç­', '9ç­'] },
            product: { name: 'äº§å“å¥—é¤', headers: ['äº§å“åç§°', 'è¯¾ç¨‹1', 'è¯¾ç¨‹2', 'è¯¾ç¨‹3', 'è¯¾ç¨‹4', 'è¯¾ç¨‹5', 'è¯¾ç¨‹6', 'è¯¾ç¨‹7', 'è¯¾ç¨‹8', 'è¯¾ç¨‹9', 'è¯¾ç¨‹10', 'è¯¾ç¨‹11'] },
            courses: { name: 'è¯¾ç¨‹è¡¨', headers: ['åºå·', 'ç­çº§', 'è¯¾ç¨‹å¤§ç±»', 'ç§‘ç›®åç§°', 'ä¸»è®²äºº', 'æ—¥æœŸ', 'æ—¶é—´æ®µ', 'è¯¾ç¨‹å¼€å§‹æ—¶é—´', 'è¯¾ç¨‹ç»“æŸæ—¶é—´', 'è¯¾æ—¶/h', 'ä¸Šè¯¾é“¾æ¥'] },
            students: { name: 'å­¦ç”Ÿ', headers: ['åºå·', 'å§“å', 'æ‰‹æœºå·ç ', 'é¡¹ç›®åç§°', 'ç­çº§', 'æ ‡è¯†', 'å¤‡æ³¨'] },
            special: { name: 'è½¬ç­ç‰¹æ®Š', headers: ['åºå·', 'å§“å', 'æ‰‹æœºå·ç ', 'é¡¹ç›®åç§°', 'æ›´æ¢ç§‘ç›®', 'åŸç­çº§', 'ç°ç­çº§'] }
        };

        // å½“å‰æ¿€æ´»çš„sheet key
        let currentSheetKey = 'staff';
        // å½“å‰è¡¨çš„æ•°æ®ï¼Œæ ¼å¼ä¸º { _id, data: [...] } çš„æ•°ç»„
        let currentRows = [];

        // DOM å…ƒç´ 
        const sheetTabs = document.getElementById('sheetTabs');
        const tableHeader = document.getElementById('tableHeader').querySelector('tr');
        const tableBody = document.getElementById('tableBody');
        const addBtn = document.getElementById('addRecordBtn');
        const importBtn = document.getElementById('importExcelBtn');
        const exportBtn = document.getElementById('exportExcelBtn');
        const fileInput = document.getElementById('fileImportInput');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalForm = document.getElementById('modalForm');
        const modalCancel = document.getElementById('modalCancel');
        const modalSave = document.getElementById('modalSave');

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆå¦‚æ—¥æœŸæˆªæ–­ï¼‰
        function formatDisplayValue(sheetKey, colIndex, value) {
            if (sheetKey === 'courses' && colIndex === 5 && typeof value === 'string' && value.includes(' ')) {
                return value.split(' ')[0]; // åªè¿”å›æ—¥æœŸéƒ¨åˆ†
            }
            return value;
        }

        // æ¸²æŸ“é€‰é¡¹å¡
        function renderTabs() {
            const keys = Object.keys(SHEET_INFO);
            sheetTabs.innerHTML = keys.map(key => {
                const active = key === currentSheetKey ? 'active' : '';
                return `<button class="sheet-btn ${active}" data-sheet="${key}">${SHEET_INFO[key].name}</button>`;
            }).join('');
            document.querySelectorAll('.sheet-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const sheetKey = e.target.dataset.sheet;
                    if (sheetKey && sheetKey !== currentSheetKey) {
                        currentSheetKey = sheetKey;
                        renderTabs();
                        loadCurrentSheet(); // é‡æ–°åŠ è½½æ•°æ®
                        updateImportExportVisibility();
                    }
                });
            });
        }

        // æ ¹æ®å½“å‰è¡¨ååŠ è½½æ•°æ®
        async function loadCurrentSheet() {
            try {
                // è°ƒç”¨å¯¹åº”è¡¨çš„ list æŸ¥è¯¢ï¼Œä¾‹å¦‚ staff:list
                const result = await convexClient.query(`${currentSheetKey}:list`);
                // æœŸæœ›è¿”å›æ ¼å¼ï¼š[ { _id, data: [...] }, ... ]
                currentRows = result || [];
                renderTable();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯å‡½æ•°æ˜¯å¦å·²å®šä¹‰');
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const sheet = SHEET_INFO[currentSheetKey];
            if (!sheet) return;

            const headers = [...sheet.headers, 'æ“ä½œ'];
            tableHeader.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

            if (currentRows.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${headers.length}" class="empty-data">æš‚æ— æ•°æ®ï¼Œè¯·æ–°å¢è®°å½•</td></tr>`;
                return;
            }

            let html = '';
            currentRows.forEach((item, rowIndex) => {
                const rowData = item.data; // æ•°ç»„
                html += '<tr>';
                rowData.forEach((cell, colIndex) => {
                    const displayVal = formatDisplayValue(currentSheetKey, colIndex, cell);
                    html += `<td title="${cell || ''}">${displayVal !== '' && displayVal != null ? displayVal : 'â€”'}</td>`;
                });
                html += `<td class="action-cell">
                    <button class="edit-btn" data-id="${item._id}" data-index="${rowIndex}" title="ç¼–è¾‘">âœï¸</button>
                    <button class="delete-btn" data-id="${item._id}" title="åˆ é™¤">ğŸ—‘ï¸</button>
                </td>`;
                html += '</tr>';
            });
            tableBody.innerHTML = html;

            // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    openEditModal(id);
                });
            });
            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    if (confirm('ç¡®è®¤åˆ é™¤è¯¥è®°å½•ï¼Ÿ')) deleteRow(id);
                });
            });
        }

        // åˆ é™¤è®°å½•
        async function deleteRow(id) {
            try {
                await convexClient.mutation(`${currentSheetKey}:remove`, { id });
                // é‡æ–°åŠ è½½æ•°æ®
                await loadCurrentSheet();
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // æ‰“å¼€æ¨¡æ€æ¡†ï¼ˆç¼–è¾‘æˆ–æ–°å¢ï¼‰
        function openEditModal(id = null) {
            const sheet = SHEET_INFO[currentSheetKey];
            const headers = sheet.headers;
            let rowData = [];
            if (id) {
                // ç¼–è¾‘ï¼šæ ¹æ®idæ‰¾åˆ°å½“å‰æ•°æ®
                const found = currentRows.find(item => item._id === id);
                rowData = found ? found.data : Array(headers.length).fill('');
            } else {
                // æ–°å¢ï¼šç©ºæ•°ç»„
                rowData = Array(headers.length).fill('');
            }

            modalTitle.textContent = id ? 'ç¼–è¾‘è®°å½•' : 'æ–°å¢è®°å½•';
            let formHtml = '';
            headers.forEach((header, i) => {
                formHtml += `
                    <div class="form-row">
                        <label for="field_${i}">${header}</label>
                        <input type="text" id="field_${i}" value="${(rowData[i] || '').toString().replace(/"/g, '&quot;')}" placeholder="è¯·è¾“å…¥${header}">
                    </div>
                `;
            });
            modalForm.innerHTML = formHtml;
            // å°†æ­£åœ¨ç¼–è¾‘çš„idå­˜å‚¨åœ¨æ¨¡æ€æ¡†ä¸Šï¼Œä»¥ä¾¿ä¿å­˜æ—¶ä½¿ç”¨
            modalOverlay.dataset.editId = id || '';
            modalOverlay.style.display = 'flex';
        }

        function closeModal() {
            modalOverlay.style.display = 'none';
            modalForm.innerHTML = '';
            delete modalOverlay.dataset.editId;
        }

        // ä¿å­˜æ¨¡æ€æ¡†æ•°æ®
        async function saveModalData() {
            const sheet = SHEET_INFO[currentSheetKey];
            const headers = sheet.headers;
            const inputs = document.querySelectorAll('#modalForm input');
            if (inputs.length !== headers.length) return;

            const newRow = Array.from(inputs).map(input => input.value.trim());
            const editId = modalOverlay.dataset.editId;

            try {
                if (editId) {
                    // æ›´æ–°
                    await convexClient.mutation(`${currentSheetKey}:update`, { id: editId, row: newRow });
                } else {
                    // æ–°å¢
                    await convexClient.mutation(`${currentSheetKey}:insert`, { row: newRow });
                }
                closeModal();
                // é‡æ–°åŠ è½½æ•°æ®
                await loadCurrentSheet();
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­—æ®µæˆ–åç«¯å‡½æ•°');
            }
        }

        // æ˜¾ç¤º/éšè—å¯¼å…¥å¯¼å‡ºæŒ‰é’®ï¼ˆä¸åŸé€»è¾‘ä¿æŒä¸€è‡´ï¼‰
        function updateImportExportVisibility() {
            if (currentSheetKey === 'staff' || currentSheetKey === 'class') {
                importBtn.classList.add('hidden');
                exportBtn.classList.add('hidden');
            } else {
                importBtn.classList.remove('hidden');
                exportBtn.classList.remove('hidden');
            }
        }

        // ========== å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ï¼ˆé€‚é… Convexï¼‰ ==========
        // å¯¼å‡ºå½“å‰è¡¨ä¸º Excel
        async function exportToExcel() {
            const sheet = SHEET_INFO[currentSheetKey];
            // ä» currentRows ä¸­æå– data æ•°ç»„
            const dataRows = currentRows.map(item => item.data);
            const data = [sheet.headers, ...dataRows];
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, sheet.name);
            XLSX.writeFile(wb, `${sheet.name}.xlsx`);
        }

        // å¯¼å…¥ Excel æ–‡ä»¶ï¼ˆæ›¿æ¢å½“å‰è¡¨æ•°æ®ï¼‰
        async function importFromExcel(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const ab = e.target.result;
                const wb = XLSX.read(ab, { type: 'array' });
                const firstSheet = wb.SheetNames[0];
                const ws = wb.Sheets[firstSheet];
                const importedData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                if (importedData.length === 0) {
                    alert('æ–‡ä»¶æ— å†…å®¹');
                    return;
                }

                // ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´ï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹ä½œä¸ºæ•°æ®
                const rows = importedData.slice(1).map(row => {
                    // ç¡®ä¿é•¿åº¦ä¸å½“å‰headersä¸€è‡´
                    const fullRow = Array(SHEET_INFO[currentSheetKey].headers.length).fill('');
                    row.forEach((cell, idx) => {
                        if (idx < fullRow.length) fullRow[idx] = (cell !== undefined && cell !== null) ? String(cell) : '';
                    });
                    return fullRow;
                });

                if (rows.length === 0) {
                    alert('æ²¡æœ‰æ•°æ®è¡Œå¯å¯¼å…¥');
                    return;
                }

                // ç”±äºéœ€è¦æ›¿æ¢æ•´ä¸ªè¡¨ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåˆ é™¤æ‰€æœ‰ç°æœ‰æ•°æ®ï¼Œç„¶åé€æ¡æ’å…¥
                try {
                    // è·å–å½“å‰è¡¨æ‰€æœ‰æ–‡æ¡£ID
                    const listResult = await convexClient.query(`${currentSheetKey}:list`);
                    const ids = listResult.map(item => item._id);
                    for (const id of ids) {
                        await convexClient.mutation(`${currentSheetKey}:remove`, { id });
                    }
                    // æ’å…¥æ–°æ•°æ®
                    for (const row of rows) {
                        await convexClient.mutation(`${currentSheetKey}:insert`, { row });
                    }
                    // é‡æ–°åŠ è½½
                    await loadCurrentSheet();
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥', error);
                    alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼æˆ–åç«¯å‡½æ•°');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // äº‹ä»¶ç»‘å®š
        addBtn.addEventListener('click', () => openEditModal(null));
        modalCancel.addEventListener('click', closeModal);
        modalSave.addEventListener('click', saveModalData);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });

        exportBtn.addEventListener('click', exportToExcel);

        importBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                importFromExcel(file);
            }
            fileInput.value = ''; // å…è®¸é‡å¤é€‰æ‹©åŒæ–‡ä»¶
        });

        // åˆå§‹åŒ–ï¼šæ¸²æŸ“é€‰é¡¹å¡å¹¶åŠ è½½ç¬¬ä¸€ä¸ªè¡¨çš„æ•°æ®
        renderTabs();
        loadCurrentSheet();
        updateImportExportVisibility();
    })();
</script>
</body>
</html>